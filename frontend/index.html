<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PSS Prainha - Página Inicial</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery e Inputmask para os campos do modal -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.8/jquery.inputmask.min.js"></script>
  <style>
    body { background-color: #f8f9fa; }
    .card { transition: transform 0.3s; }
    .card:hover { transform: translateY(-5px); }
    .logo { width: 80px; height: auto; }
  </style>
</head>
<body>
  <div class="container py-5">
    <div class="text-center mb-5">
      <!-- Logotipo -->
      <img src="brasao.jpg" alt="Brasão" class="logo mb-3">
      <h1 class="display-4 text-primary">Processo Seletivo Simplificado</h1>
      <p class="lead">Secretaria Municipal de Educação de Prainha-PA</p>
    </div>
    <div class="row">
      <!-- Cadastro Novo -->
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="card-title text-primary">Realize seu cadastro</h2>
            <p class="card-text">Informe seu CPF para iniciar seu cadastro.</p>
            <div class="mb-3">
              <label for="novoCpf" class="form-label">CPF</label>
              <input type="text" class="form-control text-uppercase" id="novoCpf" placeholder="000.000.000-00" maxlength="14">
            </div>
            <button id="btnCadastrar" class="btn btn-primary w-100" onclick="iniciarCadastro()">Cadastrar-se</button>
          </div>
        </div>
      </div>
      <!-- Acesso Existente -->
      <div class="col-md-6 mb-4">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="card-title text-primary">Acompanhe seu cadastro</h2>
            <div class="mb-3">
              <label for="loginCpf" class="form-label">CPF</label>
              <input type="text" class="form-control text-uppercase" id="loginCpf" placeholder="000.000.000-00" maxlength="14">
            </div>
            <div class="mb-3">
              <label for="senha" class="form-label">SENHA</label>
              <input type="password" class="form-control" id="senha">
            </div>
            <button id="btnEntrar" class="btn btn-primary w-100" onclick="validarLogin()">Entrar</button>
            <div class="mt-3 text-center">
              <!-- Link para acionar o Modal de Recuperação -->
              <a href="#" class="text-primary" data-bs-toggle="modal" data-bs-target="#modalRecuperar">Esqueceu sua senha?</a>
            </div>
            <!-- Spinner de Loading -->
            <div id="loading" class="d-none text-center mt-3">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Carregando...</span>
              </div>
              <p>Carregando, por favor aguarde...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de Recuperação de Senha -->
  <div class="modal fade" id="modalRecuperar" tabindex="-1" aria-labelledby="modalRecuperarLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="formRecuperar">
          <div class="modal-header">
            <h5 class="modal-title" id="modalRecuperarLabel">Recuperação de Senha</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <!-- Etapa 1: Coleta e Verificação dos Dados -->
            <div id="step1">
              <div class="mb-3">
                <label for="recuperarCpf" class="form-label">CPF</label>
                <input type="text" class="form-control" id="recuperarCpf" placeholder="000.000.000-00" required maxlength="14">
              </div>
              <div class="mb-3">
                <label for="recuperarRg" class="form-label">RG</label>
                <input type="text" class="form-control" id="recuperarRg" required>
              </div>
              <div class="mb-3">
                <label for="recuperarNome" class="form-label">Nome Completo</label>
                <input type="text" class="form-control" id="recuperarNome" required>
              </div>
              <div class="mb-3">
                <label for="recuperarDataNascimento" class="form-label">Data de Nascimento</label>
                <input type="text" class="form-control" id="recuperarDataNascimento" placeholder="DD/MM/AAAA" required maxlength="10">
              </div>
              <div class="mb-3">
                <label for="recuperarCelular" class="form-label">Celular</label>
                <input type="text" class="form-control" id="recuperarCelular" placeholder="(99) 99999-9999" required>
              </div>
              <button type="button" class="btn btn-primary w-100" id="btnVerificarRecuperacao">Verificar Dados</button>
            </div>
            <!-- Etapa 2: Redefinição da Senha -->
            <div id="step2" style="display: none;">
              <div class="mb-3">
                <label for="novaSenha" class="form-label">Nova Senha</label>
                <input type="password" class="form-control" id="novaSenha" required>
              </div>
              <div class="mb-3">
                <label for="confirmarNovaSenha" class="form-label">Confirmar Nova Senha</label>
                <input type="password" class="form-control" id="confirmarNovaSenha" required>
              </div>
              <button type="submit" class="btn btn-success w-100">Redefinir Senha</button>
            </div>
            <div id="recuperarMensagem" class="mt-3"></div>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Scripts Personalizados -->
  <script>
    // Função para formatar o CPF
    function formatarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length > 11) cpf = cpf.slice(0, 11);
      return cpf
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d)/, '$1.$2')
        .replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    }

    // Aplica a formatação para os campos de CPF
    document.getElementById('novoCpf').addEventListener('input', function() {
      this.value = formatarCPF(this.value);
    });
    document.getElementById('loginCpf').addEventListener('input', function() {
      this.value = formatarCPF(this.value);
    });
    document.getElementById('recuperarCpf').addEventListener('input', function() {
      this.value = formatarCPF(this.value);
    });
    
    // Garante que o nome seja enviado em MAIÚSCULO
    document.getElementById('recuperarNome').addEventListener('input', function() {
      this.value = this.value.toUpperCase();
    });
    
    // Inicializa as máscaras para Data de Nascimento e Celular no modal
    $(document).ready(function(){
      $("#recuperarDataNascimento").inputmask("99/99/9999");
      $("#recuperarCelular").inputmask("(99) 99999-9999");
    });

    // Função para iniciar cadastro
    async function iniciarCadastro() {
      const cpfInput = document.getElementById('novoCpf');
      const btnCadastrar = document.getElementById('btnCadastrar');
      const cpfLimpo = cpfInput.value.replace(/\D/g, '');
      if (cpfLimpo.length !== 11) {
        alert('CPF inválido! Por favor, verifique e tente novamente.');
        cpfInput.classList.add('is-invalid');
        return;
      }
      cpfInput.classList.remove('is-invalid');
      btnCadastrar.disabled = true;
      btnCadastrar.textContent = "Verificando...";
      try {
        const response = await fetch(`/api/candidatos/check?cpf=${cpfLimpo}`);
        const data = await response.json();
        if (data.exists) {
          alert(data.message);
          btnCadastrar.disabled = false;
          btnCadastrar.textContent = "Cadastrar-se";
          return;
        }
        window.location.href = '/cadastro.html?cpf=' + cpfLimpo;
      } catch (error) {
        console.error(error);
        alert('Erro ao verificar CPF. Tente novamente.');
        btnCadastrar.disabled = false;
        btnCadastrar.textContent = "Cadastrar-se";
      }
    }

    // Função de login
    async function validarLogin() {
      const cpfInput = document.getElementById('loginCpf');
      const btnEntrar = document.getElementById('btnEntrar');
      const loading = document.getElementById('loading');
      const cpfLimpo = cpfInput.value.replace(/\D/g, '');
      if (cpfLimpo.length !== 11) {
        alert('CPF inválido! Por favor, verifique e tente novamente.');
        cpfInput.classList.add('is-invalid');
        return;
      }
      cpfInput.classList.remove('is-invalid');
      const senha = document.getElementById('senha').value;
      btnEntrar.disabled = true;
      btnEntrar.textContent = "Carregando...";
      loading.classList.remove('d-none');
      try {
        const response = await fetch('/api/auth', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ cpf: cpfLimpo, senha })
        });
        if(response.ok) {
          window.location.href = `/visualiza.html?cpf=${cpfLimpo}`;
        } else {
          alert('CPF ou senha incorretos');
          btnEntrar.disabled = false;
          btnEntrar.textContent = "Entrar";
          loading.classList.add('d-none');
        }
      } catch (error) {
        console.error(error);
        alert('Erro ao conectar com o servidor.');
        btnEntrar.disabled = false;
        btnEntrar.textContent = "Entrar";
        loading.classList.add('d-none');
      }
    }

    // Eventos do Modal de Recuperação de Senha

    // Evento para verificar os dados informados (Etapa 1)
    document.getElementById('btnVerificarRecuperacao').addEventListener('click', async function() {
      const cpf = document.getElementById('recuperarCpf').value;
      const rg = document.getElementById('recuperarRg').value.trim();
      const nome = document.getElementById('recuperarNome').value.trim();
      const dataNascimento = document.getElementById('recuperarDataNascimento').value.trim();
      const celular = document.getElementById('recuperarCelular').value;
      
      if (!cpf || !rg || !nome || !dataNascimento || !celular) {
        document.getElementById('recuperarMensagem').innerHTML = '<div class="alert alert-danger">Preencha todos os campos.</div>';
        return;
      }
      
      try {
        const response = await fetch('/api/candidatos/recover/verify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cpf, rg, nome, data_nascimento: dataNascimento, celular })
        });
        const result = await response.json();
        if (response.ok && result.success) {
          document.getElementById('recuperarMensagem').innerHTML = '<div class="alert alert-success">Dados confirmados. Agora, defina sua nova senha.</div>';
          document.getElementById('step1').style.display = 'none';
          document.getElementById('step2').style.display = 'block';
        } else {
          document.getElementById('recuperarMensagem').innerHTML = `<div class="alert alert-danger">${result.error || "Dados não conferem."}</div>`;
        }
      } catch (error) {
        console.error(error);
        document.getElementById('recuperarMensagem').innerHTML = '<div class="alert alert-danger">Erro ao conectar com o servidor.</div>';
      }
    });

    // Evento de submissão da Etapa 2 (Redefinir Senha)
    document.getElementById('formRecuperar').addEventListener('submit', async function(e) {
      e.preventDefault();
      if (document.getElementById('step2').style.display !== 'block') return;
      
      const novaSenha = document.getElementById('novaSenha').value;
      const confirmarNovaSenha = document.getElementById('confirmarNovaSenha').value;
      if (novaSenha !== confirmarNovaSenha) {
        document.getElementById('recuperarMensagem').innerHTML = '<div class="alert alert-danger">As senhas não conferem.</div>';
        return;
      }
      
      const cpf = document.getElementById('recuperarCpf').value;
      try {
        const response = await fetch('/api/candidatos/recover/update', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ cpf, novaSenha })
        });
        const result = await response.json();
        if (response.ok && result.success) {
          document.getElementById('recuperarMensagem').innerHTML = '<div class="alert alert-success">Senha atualizada com sucesso.</div>';
          setTimeout(() => {
            // Fecha o modal e reseta os campos
            const modalRecuperarEl = document.getElementById('modalRecuperar');
            const modalRecuperar = bootstrap.Modal.getInstance(modalRecuperarEl);
            modalRecuperar.hide();
          }, 1500);
        } else {
          document.getElementById('recuperarMensagem').innerHTML = `<div class="alert alert-danger">${result.error || "Falha ao atualizar senha."}</div>`;
        }
      } catch (error) {
        console.error(error);
        document.getElementById('recuperarMensagem').innerHTML = '<div class="alert alert-danger">Erro ao conectar com o servidor.</div>';
      }
    });
    
    // Evento para limpar os campos quando o modal for fechado
    const modalRecuperarEl = document.getElementById('modalRecuperar');
    modalRecuperarEl.addEventListener('hidden.bs.modal', function () {
      // Reseta o formulário e as mensagens
      document.getElementById('formRecuperar').reset();
      document.getElementById('step1').style.display = 'block';
      document.getElementById('step2').style.display = 'none';
      document.getElementById('recuperarMensagem').innerHTML = '';
    });
  </script>
</body>
</html>
